<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Reversi – Room</title>
  <style>
    body { font-family: system-ui, sans-serif; line-height: 1.6; margin: 24px; }
    .row { margin: 8px 0; }
    .btn { display:inline-block; padding:6px 10px; border:1px solid #ccc; border-radius:6px; text-decoration:none; cursor:pointer; }
    .btn:hover { background:#f7f7f7; }
    code { background:#f6f8fa; padding:2px 6px; border-radius:4px; }
  </style>
</head>
<body>
  <h1>Reversi – Room</h1>

  <div class="row">
    room id: <code id="ui-id">-</code>
    / seat: <code id="ui-seat">-</code>
  </div>

  <div class="row">
    role: <code id="ui-role">-</code> /
    step: <code id="ui-step">-</code> /
    token: <code id="ui-token">-</code>
  </div>

  <div class="row">
    <button id="btn-join" class="btn">Join</button>
    <span>→ <code id="url-join"></code></span>
  </div>
  <div class="row">
    <button id="btn-leave" class="btn">Leave</button>
    <span>→ <code id="url-leave"></code></span>
  </div>
  <div class="row">
    <a href="/index.html" class="btn">Back to index</a>
  </div>

  <script>
    // クエリ取り出し
    const qp   = new URLSearchParams(location.search);
    const id   = qp.get("id")   ?? "";
    const seat = qp.get("seat") ?? "observer";

    document.getElementById("ui-id").textContent   = id || "-";
    document.getElementById("ui-seat").textContent = seat;

    // GET で叩く URL を生成
    const joinUrl  = `/join?id=${encodeURIComponent(id)}&seat=${encodeURIComponent(seat)}`;
    const leaveUrl = (token) => `/leave?id=${encodeURIComponent(id)}&token=${encodeURIComponent(token)}`;

    // Join ボタン
    document.getElementById("url-join").textContent = joinUrl;
    document.getElementById("btn-join").addEventListener("click", async () => {
      const res  = await fetch(joinUrl, { method: "GET" });
      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); } catch {}
      if (!res.ok) {
        alert(`join 失敗: HTTP ${res.status}\n${text}`);
        return;
      }
      document.getElementById("ui-role").textContent  = json?.role  ?? "-";
      document.getElementById("ui-step").textContent  = json?.step  ?? "-";
      document.getElementById("ui-token").textContent = json?.token ?? "-";
      document.getElementById("url-leave").textContent = leaveUrl(json?.token ?? "");
    });

    // Leave ボタン
    document.getElementById("btn-leave").addEventListener("click", async () => {
      const token = document.getElementById("ui-token").textContent.trim();
      if (!token || token === "-") {
        alert("token がありません（先に join してください）");
        return;
      }
      const url = leaveUrl(token);
      const res  = await fetch(url, { method: "GET" });
      const text = await res.text();
      if (!res.ok) {
        alert(`leave 失敗: HTTP ${res.status}\n${text}`);
        return;
      }
      alert("leave 完了\n" + text);
    });
  </script>
</body>
</html>