<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Reversi – Room</title>
  <style>
    body { font-family: system-ui, sans-serif; line-height: 1.6; margin: 24px; }
    .row { margin: 8px 0; }
    .btn { display:inline-block; padding:6px 10px; border:1px solid #ccc; border-radius:6px; text-decoration:none; cursor:pointer; }
    .btn:hover { background:#f7f7f7; }
    code { background:#f6f8fa; padding:2px 6px; border-radius:4px; }
  </style>
</head>
<body>
  <h1>Reversi – Room</h1>

  <div class="row">
    room id: <code id="ui-id">-</code>
    / seat: <code id="ui-seat">-</code>
  </div>

  <div class="row">
    role: <code id="ui-role">-</code> /
    step: <code id="ui-step">-</code> /
    token: <code id="ui-token">-</code>
  </div>

  <div class="row">
    <button id="btn-join" class="btn">Join</button>
    <button id="btn-leave" class="btn">Leave</button>
    <a href="/index.html" class="btn">Back to index</a>
  </div>

  <script>
    // ★ URLクエリにも付け、POST本文にも同じ内容を積む（両対応）
    async function postForm(path, kv) {
      const qs  = new URLSearchParams(kv);
      const url = `${path}?${qs.toString()}`;
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: qs.toString(), // ← 本文にも同じものを入れる
      });
      const text = await res.text(); // 生のまま読む
      let json = null;
      try { json = JSON.parse(text); } catch (_) {}
      return { ok: res.ok, status: res.status, json, text };
    }

    // クエリ取り出し
    const qp   = new URLSearchParams(location.search);
    const id   = qp.get("id")   ?? "";
    const seat = qp.get("seat") ?? "observer";

    document.getElementById("ui-id").textContent   = id || "-";
    document.getElementById("ui-seat").textContent = seat;

    // Join
    document.getElementById("btn-join").addEventListener("click", async () => {
      if (!id) { alert("id がありません"); return; }
      const { ok, json, status, text } = await postForm("/join", { id, seat });
      if (!ok) { alert(`join 失敗: HTTP ${status}\n${text}`); return; }
      document.getElementById("ui-role").textContent  = json?.role  ?? "-";
      document.getElementById("ui-step").textContent  = json?.step  ?? "-";
      document.getElementById("ui-token").textContent = json?.token ?? "-";
    });

    // Leave
    document.getElementById("btn-leave").addEventListener("click", async () => {
      if (!id) { alert("id がありません"); return; }
      const token = document.getElementById("ui-token").textContent.trim();
      if (!token || token === "-") { alert("token がありません（先に join）"); return; }
      const { ok, status, text } = await postForm("/leave", { id, token });
      if (!ok) { alert(`leave 失敗: HTTP ${status}\n${text}`); return; }
      alert("leave 完了");
    });
  </script>
</body>
</html>