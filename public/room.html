<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Reversi Room Test</title>
  <style>
    body { font-family: system-ui, sans-serif; line-height: 1.6; }
    .row { margin: 8px 0; }
    a.button { display:inline-block; padding:6px 10px; border:1px solid #ccc; border-radius:6px; text-decoration:none; }
    code { background:#f6f8fa; padding:2px 6px; border-radius:4px; }
  </style>
</head>
<body>
  <h1>Room Test</h1>

  <div class="row">
    <label>id: <input id="room-id" value="1" size="6"></label>
  </div>

  <div class="row">
    <!-- join: seat はリンクの data-seat から、id は入力欄から -->
    <a href="#" class="button" data-action="join" data-seat="black">Join (black)</a>
    <a href="#" class="button" data-action="join" data-seat="white">Join (white)</a>
    <a href="#" class="button" data-action="join" data-seat="observer">Join (observer)</a>
  </div>

  <div class="row">
    <!-- leave: token は下の表示から拾う、id は入力欄から -->
    <a href="#" class="button" data-action="leave">Leave</a>
    <a href="#" class="button" data-action="reset">Reset</a>
  </div>

  <hr />

  <div class="row">
    <strong>Last Response</strong><br/>
    role: <code id="role">-</code> /
    step: <code id="step">-</code> /
    token: <code id="token">-</code>
  </div>

  <script>
    // 共通の POST(form-urlencoded)
    async function postForm(path, payload) {
      const body = new URLSearchParams(payload);
      const res  = await fetch(path, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });
      // join は JSON、leave/reset は OKだけなど、状況に応じて try
      let json = null;
      try { json = await res.json(); } catch (_) {}
      return { ok: res.ok, status: res.status, json };
    }

    // クリックを1か所で拾う（イベント委任）
    document.addEventListener("click", async (e) => {
      const a = e.target.closest("a.button");
      if (!a) return;
      e.preventDefault();

      const idInput = document.getElementById("room-id");
      const id = (idInput.value || "").trim();
      if (!id) { alert("id を入力してください"); return; }

      const action = a.dataset.action;

      if (action === "join") {
        const seat = a.dataset.seat || "observer";
        const { ok, json } = await postForm("/join", { id, seat });
        if (!ok) { alert("join NG"); return; }

        // 期待するレスポンス: { token, role, step }
        if (json) {
          document.getElementById("token").textContent = json.token ?? "-";
          document.getElementById("role").textContent  = json.role ?? "-";
          document.getElementById("step").textContent  = json.step ?? "-";
        }
      }

      if (action === "leave") {
        const token = document.getElementById("token").textContent.trim();
        if (!token || token === "-") { alert("token がありません（先に join してください）"); return; }
        await postForm("/leave", { id, token });
        // サーバは OK を返すだけの想定。表示は据え置きか、必要なら消す：
        // document.getElementById("role").textContent = "-";
        // document.getElementById("token").textContent = "-";
      }

      if (action === "reset") {
        await postForm("/reset", { id });
        // 表示を初期化してもOK
        // document.getElementById("role").textContent  = "-";
        // document.getElementById("token").textContent = "-";
        // document.getElementById("step").textContent  = "-";
      }
    });
  </script>
</body>
</html>