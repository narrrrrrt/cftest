<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Reversi – Room (GET & POST form-body)</title>
  <style>
    body { font-family: system-ui, sans-serif; line-height: 1.6; margin: 24px; }
    .row { margin: 8px 0; }
    .btn { display:inline-block; padding:6px 10px; border:1px solid #ccc; border-radius:6px; text-decoration:none; cursor:pointer; }
    .btn:hover { background:#f7f7f7; }
    code { background:#f6f8fa; padding:2px 6px; border-radius:4px; }
    h2 { margin-top: 32px; }
  </style>
</head>
<body>
  <h1>Reversi – Room (GET / POST 並列)</h1>

  <div class="row">
    room id: <code id="ui-id">-</code>
    / seat: <code id="ui-seat">-</code>
  </div>
  <div class="row">
    role: <code id="ui-role">-</code> /
    step: <code id="ui-step">-</code> /
    token: <code id="ui-token">-</code>
  </div>

  <!-- ========== GET セクション ========== -->
  <h2>GET メソッド</h2>
  <div class="row">
    <button id="btn-join-get" class="btn">Join (GET)</button>
    <span>→ <code id="url-join-get"></code></span>
  </div>
  <div class="row">
    <button id="btn-leave-get" class="btn">Leave (GET)</button>
    <span>→ <code id="url-leave-get"></code></span>
  </div>

  <!-- ========== POST セクション ========== -->
  <h2>POST メソッド (form-urlencoded)</h2>
  <div class="row">
    <button id="btn-join-post" class="btn">Join (POST form)</button>
    <span>→ <code>/join</code></span>
  </div>
  <div class="row">
    <button id="btn-leave-post" class="btn">Leave (POST form)</button>
    <span>→ <code>/leave</code></span>
  </div>

  <div class="row">
    <a href="/index.html" class="btn">Back to index</a>
  </div>

  <script>
    // クエリ取り出し
    const qp   = new URLSearchParams(location.search);
    const id   = qp.get("id")   ?? "";
    const seat = qp.get("seat") ?? "observer";

    document.getElementById("ui-id").textContent   = id || "-";
    document.getElementById("ui-seat").textContent = seat;

    // ------------------- GET -------------------
    const joinUrl  = `/join?id=${encodeURIComponent(id)}&seat=${encodeURIComponent(seat)}`;
    const leaveUrl = (token) => `/leave?id=${encodeURIComponent(id)}&token=${encodeURIComponent(token)}`;

    document.getElementById("url-join-get").textContent = joinUrl;

    document.getElementById("btn-join-get").addEventListener("click", async () => {
      const res  = await fetch(joinUrl, { method: "GET" });
      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); } catch {}
      if (!res.ok) { alert(`join失敗(GET): HTTP ${res.status}\n${text}`); return; }
      document.getElementById("ui-role").textContent  = json?.role  ?? "-";
      document.getElementById("ui-step").textContent  = json?.step  ?? "-";
      document.getElementById("ui-token").textContent = json?.token ?? "-";
      document.getElementById("url-leave-get").textContent = leaveUrl(json?.token ?? "");
    });

    document.getElementById("btn-leave-get").addEventListener("click", async () => {
      const token = document.getElementById("ui-token").textContent.trim();
      if (!token || token === "-") { alert("tokenがありません（先にjoinしてください）"); return; }
      const url = leaveUrl(token);
      const res  = await fetch(url, { method: "GET" });
      const text = await res.text();
      if (!res.ok) { alert(`leave失敗(GET): HTTP ${res.status}\n${text}`); return; }
      alert("leave完了(GET)\n" + text);
    });

    // ------------------- POST -------------------
    document.getElementById("btn-join-post").addEventListener("click", async () => {
      const body = new URLSearchParams({ id, seat });
      const res = await fetch("/join", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body.toString()
      });
      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); } catch {}
      if (!res.ok) { alert(`join失敗(POST): HTTP ${res.status}\n${text}`); return; }
      document.getElementById("ui-role").textContent   = json?.role  ?? "-";
      document.getElementById("ui-step").textContent   = json?.step  ?? "-";
      document.getElementById("ui-token").textContent  = json?.token ?? "-";
    });

    document.getElementById("btn-leave-post").addEventListener("click", async () => {
      const token = document.getElementById("ui-token").textContent.trim();
      if (!token || token === "-") { alert("tokenがありません（先にjoinしてください）"); return; }
      const body = new URLSearchParams({ id, token });
      const res = await fetch("/leave", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body.toString()
      });
      const text = await res.text();
      if (!res.ok) { alert(`leave失敗(POST): HTTP ${res.status}\n${text}`); return; }
      alert("leave完了(POST)\n" + text);
    });
  </script>
</body>
</html>