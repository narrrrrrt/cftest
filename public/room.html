<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Reversi – Room</title>
  <style>
    body { font-family: system-ui, sans-serif; line-height: 1.6; margin: 24px; }
    .row { margin: 8px 0; }
    .btn { display:inline-block; padding:6px 10px; border:1px solid #ccc; border-radius:6px; text-decoration:none; cursor:pointer; }
    .btn:hover { background:#f7f7f7; }
    code { background:#f6f8fa; padding:2px 6px; border-radius:4px; }
  </style>
</head>
<body>
  <h1>Reversi – Room</h1>

  <div class="row">
    room id: <code id="ui-id">-</code>
    / seat: <code id="ui-seat">-</code>
  </div>

  <div class="row">
    role: <code id="ui-role">-</code> /
    step: <code id="ui-step">-</code> /
    token: <code id="ui-token">-</code>
  </div>

  <div class="row">
    <button id="btn-leave" class="btn">Leave</button>
    <a href="/index.html" class="btn">Back to index</a>
  </div>

  <script>
    // 共通: x-www-form-urlencoded で POST
    async function postForm(path, kv) {
      const body = new URLSearchParams(kv);
      const res  = await fetch(path, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body.toString(),
      });
      let json = null;
      try { json = await res.json(); } catch (_) {}
      return { ok: res.ok, status: res.status, json };
    }

    // クエリ取得
    const qp   = new URLSearchParams(location.search);
    const id   = qp.get("id")   ?? "";
    const seat = qp.get("seat") ?? "observer"; // 念のため既定 observer

    // 画面にクエリ表示
    document.getElementById("ui-id").textContent   = id || "-";
    document.getElementById("ui-seat").textContent = seat;

    // 初回 join（id/seat を POST）
    (async () => {
      if (!id) {
        alert("id が指定されていません。index から入り直してください。");
        return;
      }
      const { ok, json, status } = await postForm("/join", { id, seat });
      if (!ok) {
        alert(`join 失敗: HTTP ${status}`);
        return;
      }
      // 期待: { token, role, step }
      document.getElementById("ui-role").textContent  = json?.role  ?? "-";
      document.getElementById("ui-step").textContent  = json?.step  ?? "-";
      document.getElementById("ui-token").textContent = json?.token ?? "-";
    })();

    // Leave: 表示中 token を使って POST /leave（id, token）
    document.getElementById("btn-leave").addEventListener("click", async () => {
      const token = document.getElementById("ui-token").textContent.trim();
      if (!id) {
        alert("id が空です。");
        return;
      }
      if (!token || token === "-") {
        alert("token がありません（先に join してください）。");
        return;
      }
      const { ok, status } = await postForm("/leave", { id, token });
      if (!ok) {
        alert(`leave 失敗: HTTP ${status}`);
        return;
      }
      alert("leave 完了しました。");
      // 必要なら画面の表示も初期化
      // document.getElementById("ui-role").textContent  = "-";
      // document.getElementById("ui-token").textContent = "-";
      // document.getElementById("ui-step").textContent  = "-";
    });
  </script>
</body>
</html>